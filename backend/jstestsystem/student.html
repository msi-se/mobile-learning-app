<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student</title>
</head>
<body>
    <h1>Student</h1>
    <div id="questions"></div>
</body>


<script>

const courseId = "65c3bc52ab8a5a311e8a6eee";
const formId = "65c3bc52ab8a5a311e8a6ef1";
const profId = "65c37141a6810908414e8c07";
const jwt = "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiJ9.eyJmdWxsX25hbWUiOiJQcm9mIiwic3ViIjoiNjVjMzcxNDFhNjgxMDkwODQxNGU4YzA3IiwiZW1haWwiOiJQcm9mQGh0d2cta29uc3RhbnouZGUiLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJQcm9mIiwiZ3JvdXBzIjpbIlByb2YiXSwiZXhwIjoxNzA3Njk0Njg1LCJpYXQiOjE3MDc1MjE4ODUsImp0aSI6IjYxNTM3MDkzLTg4OTYtNDA0MC1hYWM3LWRlNWNmMzFkYWY5NiJ9.EvpgUZIefFm06vG8zxDlZ8YpoQW0n8VtQJBuvl8jD3rOL2uE1XWwMMG2_kQrSZFy7aj2JwkEOPgMqey3vyf_rEkWmRhpEM8f9n9QlJf7A1yrFU3wevE3ARrGQOla81SBLTZUJDFPjpRTVHkFOn0Ia79-DzLEVNSO63e_FG9zIPebeJVzPpI974EH_OplO17rXSsXe0o82r7P6uH1lhU59Pcz93cFSckeRhpj0-Rcp27fu_MjUgP45t0sKxvYYgBcjYbNIOYZnPtgtUeA6x0fgpNTosBAFg2K4tkD3SryXsutf9Iv9MysVK9c3gTGz41aBs8xdVQj9hl-Sp-vpuc3eQ"

let webSocket = new WebSocket(`ws://localhost:8081/course/${courseId}/feedback/form/${formId}/subscribe/${profId}/${jwt}`);

webSocket.onopen = function (event) {
    console.log("Connection established.");
}

webSocket.onmessage = function (event) {
    let data = JSON.parse(event.data);
    
    if (data.action === "FORM_STATUS_CHANGED") {
        console.log(data);
        updateForm(data.form);
    };
}

// first fetch the different elements of the form
// /feedback/channel/{channelId}/form/{formId}
fetch(`http://localhost:8080/feedback/channel/${channelId}/form/${formId}`)
    .then(response => response.json())
    .then(form => {
        console.log(form);
        // form.elements: array of elements
        // element.type:  SLIDER | STARS | FULLTEXT | YES_NO
        // element.id: string
        // element.name: string
        // element.description: string

        updateForm(form);

        form.elements?.forEach(element => {
            // create a div for each element
            let div = document.createElement("div");
            div.id = element.id;
            div.innerHTML = `
                <h3>${element.name}</h3>
                <p>${element.description}</p>
            `;

            // create the input element
            let input = null;
            if (element.type === "SLIDER") {
                input = document.createElement("input");
                input.type = "range";
                input.min = "0";
                input.max = "10";
                input.value = "0";
                input.step = "1";
            }
            if (element.type === "STARS") {
                input = document.createElement("input");
                input.type = "range";
                input.min = "1";
                input.max = "5";
                input.value = "1";
                input.step = "1";
            }
            if (element.type === "FULLTEXT") {
                input = document.createElement("input");
                input.type = "text";
            }
            if (element.type === "YES_NO") {
                input = document.createElement("select");
                let optionYes = document.createElement("option");
                optionYes.value = "YES";
                optionYes.innerHTML = "YES";
                let optionNo = document.createElement("option");
                optionNo.value = "NO";
                optionNo.innerHTML = "NO";
                input.appendChild(optionNo);
                input.appendChild(optionYes);
            }

            // add the input element to the div
            div.appendChild(input);

            // add the div to the questions div
            document.getElementById("questions").appendChild(div);

            // add an event listener to the input element
            input.addEventListener("change", (event) => {
                // send a message to the server
                let message = {
                    "action": "ADD_RESULT",
                    "resultElementId": element.id,
                    "resultValue": input.value,
                    "role": "STUDENT"
                };
                webSocket.send(JSON.stringify(message));
            });
        });
    });

function updateForm(form) {

    console.log("Updating form: ", form);

    if (form.status === "NOT_STARTED") {
        document.getElementById("questions").style.display = "none";
    }

    if (form.status === "STARTED") {
        document.getElementById("questions").style.display = "block";
    }

    if (form.status === "FINISHED") {
        document.getElementById("questions").style.display = "none";
    }
}

    

</script>

</html>